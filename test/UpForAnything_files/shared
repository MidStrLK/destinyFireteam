function checkForInvalids(){$(".recipients").find(".invalid").length<1&&$(".recipients").find(".error.noId").length&&$(".recipients").find(".error.noId").remove();($(".recipients").find(".recipient").length===1&&$(".recipients").find(".recipient [contenteditable=true]").attr("data-membershipid")!==myID_cookie||($(".recipients").find(".recipient").length<1||$(".recipients").find(".recipient [contenteditable=true]").length>1)&&$(".recipients").find(".error.noSelfOnly").length)&&$(".recipients").find(".error.noSelfOnly").remove()}var Following={},suggestedUsers,SignIn,TagSuggestions;Following.populate_onPageGroupModel=function(n){viewModels.onPageGroupModel(n);viewModels.onPageGroupModelIsLoaded(!0)};Following.followingIsReady=!0;Following.loadFollowedEntitiesForCurrentUser=function(){};Following.follow=function(n){var t=n,f,r,i,u;t.filter("[data-membershipId]").length?(r=t.data("membershipid"),bungieNetPlatform.activityService.FollowUser(r,function(n){var r=n.membershipId,t={"0":PageUrls.profilePage+"/254/"+n.membershipId,"1":n.membershipId,"2":n.displayName,"4":PageUrls.profilePage+"/254/"+myID_cookie+"#context=membership&tab=usersFollowed"},i=Localizer.fnStringReplace(Localizer.Community.followinguserconfirmationmessage,t);Utility.alertSuccess(i,Globals.SuccessMessages.Following);$("#alert").addClass("follow");customAlert.afterClose=function(){Bnet.Site.PageController.Instance.reloadPage()};Following.followingIsReady=!0},function(n){Utility.alert(n.errorMessage);Following.followingIsReady=!0})):t.filter("[data-tag]").length?(i=t.data("tag"),u=!1,t.closest("#followingTags").length&&(u=!0,f=t.closest("#followingTags").find(".btn_blue[data-tag='"+i+"']")),bungieNetPlatform.activityService.FollowTag(i,function(){var n,t,r;Following.followingIsReady=!0;n={"0":i,"2":PageUrls.profilePage+"/254/"+myID_cookie+"#context=membership&tab=tags"};t=Localizer.fnStringReplace(Localizer.Community.followingtagconfirmationmessage,n);Utility.alertSuccess(t,Globals.SuccessMessages.Following);customAlert.afterClose=function(){Bnet.Site.PageController.Instance.reloadPage()};$("#alert").addClass("follow");$(".nav_top .activity").addClass("pulse");r=setTimeout(function(){$(".nav_top .activity.pulse").removeClass("pulse")},6e3)},function(n){Utility.alert(n.errorMessage);Following.followingIsReady=!0})):t.filter("[data-groupId]").length&&bungieNetPlatform.activityService.FollowGroup(groupId,function(n){var t=n.detail,i,r,u;bungieNetPlatform.activityService.GetEntitiesFollowedByCurrentUser(function(n){populate_myFollowedModels(n);Following.followingIsReady=!0},function(){Following.followingIsReady=!0});bungieNetPlatform.groupService.GetGroup(t.groupId,!0,Following.populate_onPageGroupModel,function(){});i={"0":PageUrls.clanIndex+"/"+t.groupId,"1":t.name,"2":t.groupId};r=Localizer.fnStringReplace(Localizer.Community.followinggroupconfirmationmessage,i);Utility.alertSuccess(r,Globals.SuccessMessages.Following);$("#alert").addClass("follow");$(".nav_top .activity").addClass("pulse");u=setTimeout(function(){$(".nav_top .activity.pulse").removeClass("pulse")},6e3)},function(n){Utility.alert(n.errorMessage);Following.followingIsReady=!0})};Following.unfollow=function(n){var t=n,e,i,r,u,f;t.filter("[data-membershipId]").length?(i=t.data("membershipid"),bungieNetPlatform.activityService.UnfollowUser(i,function(){Following.followingIsReady=!0;var n={"0":PageUrls.profilePage+"/254/"+i,"1":i},t=Localizer.fnStringReplace(Localizer.Community.unfollowinguserconfirmationmessage,n);Utility.alertSuccess(t,Globals.SuccessMessages.Unfollowing);UserFunctions.getUserById(i);$("#alert").addClass("follow");$("body").hasClass("Profile")?Profile._view.loadImagesLater("#followedUsers"):customAlert.afterClose=function(){Bnet.Site.PageController.Instance.reloadPage()};viewModels.myFollowedUsersModel.remove(function(n){return n.following.identifier==i})},function(n){Utility.alert(n.errorMessage);Following.followingIsReady=!0})):t.filter("[data-tag]").length?(r=t.data("tag"),u=!1,t.closest("#followingTags").length&&(u=!0,e=t.closest("#followingTags").find(".btn_blue[data-tag='"+r+"']")),bungieNetPlatform.activityService.UnfollowTag(r,function(n){viewModels.myFollowedTagsModel.remove(function(n){return n.detail.displayName.toLowerCase()==r.toLowerCase()});var t={"0":n.tagText},i=Localizer.fnStringReplace(Localizer.Community.unfollowingtagconfirmationmessage,t);Utility.alertSuccess(i,Globals.SuccessMessages.Unfollowing);$("#alert").addClass("follow");customAlert.afterClose=function(){Bnet.Site.PageController.Instance.reloadPage()};Following.followingIsReady=!0},function(n){Utility.alert(n.errorMessage);Following.followingIsReady=!0})):t.filter("[data-groupId]").length&&(f=t.attr("data-groupId"),bungieNetPlatform.activityService.UnfollowGroup(f,function(n){var t=n.detail,i,r;bungieNetPlatform.groupService.GetGroup(t.groupId,!0,function(n){typeof viewModels.onPageGroupModel!="undefined"&&Following.populate_onPageGroupModel(n);Following.followingIsReady=!0},function(){Following.followingIsReady=!0});i={"0":PageUrls.clanIndex+"/"+t.groupId,"1":t.groupId,"2":t.name};r=Localizer.fnStringReplace(Localizer.Community.unfollowinggroupconfirmationmessage,i);Utility.alertSuccess(r,Globals.SuccessMessages.Unfollowing);$("#alert").addClass("follow");typeof viewModels.myFollowedGroupsModelFull!="undefined"&&viewModels.myFollowedGroupsModelFull.remove(function(n){return n.detail.groupId()==t.groupId});viewModels.myFollowedGroupsModel.remove(function(n){return n.following.identifier==t.groupId})},function(){Utility.alert("Unable to unfollow the group.");Following.followingIsReady=!0}))};$(document).ready(function(){$(document).on("click",".btn_follow",function(n){if(n.stopImmediatePropagation(),n.preventDefault(),$(this).closest(".extraInfo_user").length&&hideUserInfo(),Following.followingIsReady){if(Following.followingIsReady=!1,SignIn.notSignedIn()){Following.followingIsReady=!0;return}var t=$(this);t.hasClass("unfollow")?Following.unfollow(t):Following.follow(t)}})});suggestedUsers={};suggestedUsers.double=[];$(document).ready(function(){function s(n){n.text()!==""&&n.text().length>3&&f!==n.text()&&!u?(clearTimeout(t),t=!1,f=n.text(),u=!0,bungieNetPlatform.userService.SearchUsers(n.text(),function(t){var o=n.closest("div"),f,r,e;if(t.length>0){f=$("#suggest");n.text().length>0&&!f.length?(f=$("<ul id='suggest' class='suggest'><\/ul>"),o.find(".error").length?o.find(".error").before(f):o.append(f),f.css("left",n.position().left+"px")):f.find("li").remove();$(document).on("click.closeSuggestions",function(n){!f.is(n.target)&&f.find(n.target).length<1&&($(document).off("click.closeSuggestions"),i())});for(r=0;r<t.length;r++){typeof suggestedUsers[t[r].displayName]=="undefined"?suggestedUsers[t[r].displayName]=t[r]:suggestedUsers.double.push(t[r].displayName);e=$("<li data-membershipId='"+t[r].membershipId+"'><img alt='' src='"+Utility.ContentVersioned(t[r].profilePicturePath)+"' width='35px' height='35px' />"+t[r].displayName+" ("+t[r].uniqueName+")<\/li>");f.append(e);e.data("recipient",n);e.on("mouseenter.recipients",function(){var n=$(this);n.addClass("hovered").siblings(".hovered").removeClass("hovered")})}}else $("#suggest").remove();u=!1},function(){$parentDiv.find(".error.noResponse").length&&$parentDiv.append('<p class="error noResponse">Technical Difficulties: No users can be found right now<\/p>');u=!1})):(t!==!1?(clearTimeout(t),t=!1):e(n),i())}function i(){$(document).off("keyup.recipients");$("#suggest").remove();f=""}function o(n){var r=$("#suggest"),t=r.find(".hovered"),i=r.find("li.on");r.find("li").off("mouseenter.recipients");n===1?i.length?i.next().length&&i.removeClass("on").next().addClass("on"):t.length?t.next().length&&(t.next().addClass("on"),t.removeClass("hovered")):r.find("li:first-child").addClass("on"):t.length?t.prev().length&&(t.prev().addClass("on"),t.removeClass("hovered")):i.length&&i.prev().length&&i.removeClass("on").prev().addClass("on")}var t=!1,r=0,u=!1,f="",e=function(n){t==!1&&(t=setTimeout(function(){s(n);clearTimeout(t);t=!1},500))},n=$(".nav_top .recipients");n.on("click.recipients",function(t){var r,u;t.preventDefault();t.stopImmediatePropagation();$(".btn_delete").is(t.target)?($(t.target).closest(".recipient").remove(),Mail.updateSendMessageButton(this),i()):(r=n.find(".container_textbox [contenteditable=true]"),r.is(t.target)||(r.length===0||r.length>0&&r.length<7&&r.last().text()!==""?(u="<li class='recipient'><p contenteditable='true' autocomplete='off'><\/p><a  class='btn_delete'>X<\/a><\/li>",$(this).find(".container_textbox").append(u),r=n.find(".container_textbox [contenteditable=true]"),r.last().focus(),i()):r.last().focus()),!$("[contenteditable=true]").is(t.target))});n.on("focus.recipients",".container_textbox [contenteditable=true]",function(){$(this).filter(".invalid").removeClass("invalid");n.find(".invalid").length==0&&n.find(".error.noId").length&&n.find(".error.noId").remove();$(this).text()===""&&i()});$(document).on("blur.extraRecipient",".recipient > [contenteditable=true]",function(){$.trim($(this).text())==""&&($(this).parents(".recipient").remove(),Mail.updateSendMessageButton(this))});n.on("keydown.recipients",".container_textbox [contenteditable=true]",function(n){if($(this).text().length>15&&[8,35,36,37,38,39,40,46].indexOf(n.which)==-1){n.stopImmediatePropagation();n.preventDefault();return}n.which=="13"&&(n.stopImmediatePropagation(),n.preventDefault())});n.on("paste.recipients",".container_textbox [contenteditable=true]",function(){var n=$(this);setTimeout(function(){n.text(n.text().substring(0,16))},25)});n.on("keyup.recipients",".container_textbox [contenteditable=true]",function(t){var u,f,s,h,c;if(t.which!=8&&t.which!=46&&(r=0),u=$(this),f=n.find(".container_textbox [contenteditable=true]"),t.which=="13")if(t.stopImmediatePropagation(),t.preventDefault(),$("#suggest").find(".on").length)$("#suggest").find(".on").trigger("click.recipients");else{i();$(".mail_create textarea").focus();return}else{if(t.which=="38"){o(-1);return}if(t.which=="40"){o(1);return}if(t.which==16)t.preventDefault();else{if(t.which=="9"){t.stopImmediatePropagation();t.preventDefault();i();$(".mail_create textarea").focus();return}u.attr("data-displayName")!==u.text()&&u.attr("data-membershipId","");u.closest(".recipient").hasClass("highlight")?u.text()===""?(t.which==8&&t.preventDefault(),f.index(u)!==0||f.index(u)===0&&f.length>1?r===1?(s=u.closest(".recipient"),h=s.prev(".recipient").length?s.prev(".recipient"):s.siblings(".recipient").last(),s.remove(),checkForInvalids(),i(),f=n.find("[contenteditable=true]"),f.length&&(h.find("[contenteditable=true]").focus(),c=h.find("[contenteditable=true]").get(0).childNodes[0],typeof c!="undefined"&&Utility.placeCaretAtEnd(h.find("[contenteditable=true]").get(0))),r=0):r++:u.closest(".recipient").removeClass("highlight")):e(u):(u.closest(".recipient").addClass("highlight"),e(u))}}});n.on("click.recipients","#suggest li",function(t){t.stopImmediatePropagation();var u=$(this),r=u.data("recipient");r.closest(".recipient").removeClass("invalid");checkForInvalids();r.text(u.text());r.attr("data-displayName",u.text());r.attr("data-membershipId",u.attr("data-membershipid"));i();n.trigger("click.recipients");Mail.updateSendMessageButton(r.get(0))})});$(document).ready(function(){$("#post, .Activity .Feed, #ActivityFeed, .mail, .myFollowedTags, .topics").on("click","span[data-tag]",function(n){if(!$(this).parent("[data-topicId], [data-groupId]").length&&(n.preventDefault(),n.stopImmediatePropagation(),!$(this).hasClass("btn_follow"))){var t="";$("#groupDetails").length&&(t="&groupId="+$("#groupDetails").attr("data-groupId"));window.location=PageUrls.defaultTopicsPage+"/0/Default/None/"+$(this).data("tag").replace("#","")+t}})});bungieNetPlatform.communitySearch={caretPos:0,keyTimeout:!1,doSearch:function(n,t,i,r,u){var u=u;(u||n.indexOf("#")!==-1)&&(n=n.replace(/#/gi,""),u=!0);n=n.replace(/[\/\\\:\&\<\>\;\'\"]/gi,"");r==="users"?u||this.getUsersPaged(n,1,i):r==="groups"?this.getGroups(n,t,i,!1,u):r==="topics"?this.getTopicsFromTags(n,t,i):r==="news"?this.getNews(n,t,i,u):r==="newsTags"?this.getNews(n,t,i,u):r==="help"?this.getHelp(n,t,i,u):r==="all"?(u||this.getUsersPaged(n,1,i,!0),this.getGroups(n,t,i,!0,u),this.getTopicsFromTags(n,t,i,!0),this.getNews(n,t,i,u),this.getHelp(n,t,i,u)):(u||this.getUsersPaged(n,1,i),this.getTopicsFromTags(n,t,i),this.getNews(n,t,i,u),this.getHelp(n,t,i,u));setTimeout(function(){var n=$("#text_search");n.get(0)!=document.activeElement&&n.focus()},1e3)},doTagSearch:function(n,t){bungieNetPlatform.forumService.GetForumTagSuggestions(n,function(n){var i,r,u;if(n.length>0)for(n.length<t&&(t=n.length),i=0;i<t;i++)r=n[i].tagText,u='<li><article><div class="content"><a href="'+PageUrls.defaultTopicsPage+"/0/Default/None/"+r.replace("#","")+'">'+r+"<\/a><\/div><\/article><\/li>",$("#container_postTags").append(u);else $("#container_postTags").append('<li><article><div class="content">'+Localizer.Search.noresults+"<\/div><\/article><\/li>")},function(){$("#container_postTags").append('<li><article><div class="content">'+Localizer.Search.noresults+"<\/div><\/article><\/li>")});bungieNetPlatform.groupService.GetGroupTagSuggestions(n,function(n){var i,r,u;if(n.length>0)for(n.length<t&&(t=n.length),i=0;i<t;i++)r=n[i].tagText,u='<li><article><div class="content"><a href="'+PageUrls.groupsPage+"?tags=%23"+r.replace("#","")+'">'+r+"<\/a><\/div><\/article><\/li>",$("#container_groupTags").append(u);else $("#container_groupTags").append('<li><article><div class="content">'+Localizer.Search.noresults+"<\/div><\/article><\/li>")},function(){$("#container_groupTags").append('<li><article><div class="content">'+Localizer.Search.noresults+"<\/div><\/article><\/li>")})},resetAdvanced:function(n){var t=$("#searchAdvanced");typeof n!="undefined"?t=n:t.closest(".header_page").css("z-index","");t.removeClass("opened");t.find(".opened").removeClass("opened");t.find("input").val("");t.find("select option:first-child").prop("selected","selected")},getTopicsFromTags:function(n,t,i,r){var f=i.find("#searchTopics, .searchTags"),e,o,u;for(f.find(".container_topics.noResults").removeClass("noResults"),f.find("li").remove(),i.find("#searchTopics").length||t<5&&(t=5),e=n.split(" "),o=0;o<e.length;o++)e[o]="#"+e[o];u=e.join(" ");bungieNetPlatform.forumService.GetTopicsPaged(0,t,0,1,0,0,u,Localizer.CurrentCultureName,function(n){for(var h={},c,s,e=0;e<n.authors.length;e++)h[n.authors[e].membershipId]=n.authors[e];for(c={},e=0;e<n.groups.length;e++)c[n.groups[e].detail.groupId]=n.groups[e];if(n.results.length>0?i.find(".searchTags h2").addClass("hasMore").bind("click.gotoTopics",function(n){n.preventDefault();window.location=PageUrls.defaultTopicsPage+"/0/Default/None/"+u.replace(/#/gi,"%23")}).find("span").text(u):i.find(".searchTags h2").find("span").text(u),s=n.results,s.length>0)for($("#topics_noresults_span").hide(),r?(n.hasMore?$("#topics_page2_link").attr("href",PageUrls.defaultTopicsPage+"/0/Default/None/"+u.replace(/#/gi,"%23")).show():$("#topics_page2_link").attr("href","").hide(),t>s.length&&(t=s.length)):i.find("#searchTopics").length?(t=s.length,n.hasMore?$("#topics_page2_link").attr("href",PageUrls.defaultTopicsPage+"/0/Default/None/"+u.replace(/#/gi,"%23")).show():$("#topics_page2_link").attr("href","").hide()):(t=2,s.length<t&&(t=s.length)),e=0;e<t;e++){var o=s[e],a=o.postId,v=o.creationDate,w=o.category,p=o.subject,l=o.authorMembershipId,y={};typeof o.parentGroupId!="undefined"&&(y={"0":c[o.parentGroupId].detail.name,"1":c[o.parentGroupId].detail.groupId,"2":Utility.makeFriendlyUrlPrefix(c[o.parentGroupId].detail.name)+PageUrls.groupDetail+"?groupId="+c[o.parentGroupId].detail.groupId});$topicItem='<li class="cf topic" data-topicId="'+a+'"><article><a href="'+PageUrls.profilePage+"/"+l+'" data-membershipId="'+h[l].membershipId+'" class="avatar"><img alt="" src="'+Utility.ContentVersioned(h[l].profilePicturePath)+'" /><\/a><div class="content"><a class="title" href="'+PageUrls.defaultPostPage+"/"+a+'">'+p+'<\/a><time datetime="'+v+'">'+Utility.getLocalTimeString(v,!1,!1)+'<\/time><p class="author"><a data-membershipid="'+h[l].membershipId+'" href="'+PageUrls.profilePage+"/"+h[l].membershipId+'">'+h[l].displayName+"<\/a>"+(typeof o.parentGroupId!="undefined"?Localizer.fnStringReplace(Localizer.Search.inthegroup,y):"")+"<\/p><\/div><\/article>";f.find(".container_topics").append($topicItem)}else f.find(".container_topics").addClass("noResults"),$("#topics_noresults_span").show()},function(n){f.find(".container_topics").addClass("errorSection").append("<li>"+n.errorMessage+"<\/li>")})},getNews:function(n,t,i,r){var u=i.find(".searchNews, .news");u.find(".container_search_news.noResults").removeClass("noResults");u.find("li").remove();bungieNetPlatform.contentService.SearchContentWithText(Localizer.CurrentCultureName,!1,"News",r?n:"",1,r?"":n,function(i){var r;if(i.results.length>0)for(u.find("#news_noresults_span").hide(),i.results.length>0&&u.find("h2").addClass("hasMore").bind("click.gotoNews",function(t){t.preventDefault();window.location=PageUrls.searchPage+"?npId="+n}),u.find("#news_page2_link").hide(),i.results.length<t&&(t=i.results.length),r=0;r<t;r++){var f=i.results[r],e=f.contentId,o=f.properties.Title.replace(/<(?:.|\n)*?>/gm,""),h=f.properties.Summary,c=f.properties.ArticleBanner,s="/"+Localizer.CurrentCultureName+"/News/Article/"+e+Utility.makeFriendlyUrlPrefix(o);$item=$('<li class="cf news" data-contentId="'+e+'"><a href="'+s+'" class="thumbnail"><img src="'+Utility.ContentVersioned(c)+'" /><\/a><div class="content"><a href="'+s+'">'+o+"<\/a><p>"+h+"<\/p><\/div><\/li>");u.find(".container_search_news").append($item)}else u.find(".container_search_news").addClass("noResults"),u.find("#news_noresults_span").show()},function(n){u.find(".container_search_news").addClass("errorSection").append("<li class='noResults'>"+n.errorMessage+"<\/li>")})},getHelp:function(n,t,i,r){var u=i.find(".searchHelp, .help");u.find(".container_search_help.noResults").removeClass("noResults");u.find("li").remove();bungieNetPlatform.contentService.SearchContentWithText(Localizer.CurrentCultureName,!1,"Help HelpStep",r?n:"",1,r?"":n,function(i){var r;if(i.results.length>0)for(u.find("#help_noresults_span").hide(),i.results.length>0&&u.find("h2").addClass("hasMore").bind("click.gotoHelp",function(t){t.preventDefault();window.location=PageUrls.searchPage+"?haId="+n}),u.find("#help_page2_link").hide(),i.results.length<t&&(t=i.results.length),r=0;r<t;r++){var f=i.results[r],e=f.contentId,o=f.properties.Title.replace(/<(?:.|\n)*?>/gm,""),h="",s="";f.cType=="Help"?(s=Utility.makeFriendlyUrlPrefix(o)+"/"+Localizer.CurrentCultureName+"/Help/Article/"+e,h=f.properties.ShortAnswer):s=Utility.makeFriendlyUrlPrefix(o)+"/"+Localizer.CurrentCultureName+"/Help/Troubleshoot?oid="+e;$item=$('<li class="cf help" data-contentId="'+e+'"><div class="content"><a href="'+s+'">'+o+"<\/a><p>"+h+"<\/p><\/div><\/li>");u.find(".container_search_help").append($item)}else u.find(".container_search_help").addClass("noResults"),u.find("#help_noresults_span").show()},function(n){u.find(".container_search_help").addClass("errorSection").append("<li class='noResults'>"+n.errorMessage+"<\/li>")})},getUsersPaged:function(n,t,i){var u=this,r=i.find(".searchUsers, .users");n.length<25?bungieNetPlatform.userService.SearchUsersPaged(n,t,function(u){var o;if(i.find(".user").remove(),u.results.length>0){for(r.find(".container_users.noResults").removeClass("noResults"),$("#user_noresults_span").hide(),r.find("h2").addClass("hasMore").bind("click.gotoUsers",function(t){t.preventDefault();window.location=PageUrls.searchPage+"?uId="+n}),u.hasMore?($(".next_page").data({value:n,container:i,page:t}).click(function(n){n.preventDefault();$(this).unbind("click");bungieNetPlatform.communitySearch.getUsersPaged($(this).data("value"),$(this).data("page")+1,$(this).data("container"))}).show(),$(".current_page").text(t),$(".footer_search_section").append($('<div class="clear"/>'))):$(".next_page").hide(),t>1?($(".prev_page").data({value:n,container:i,page:t}).click(function(n){n.preventDefault();$(this).unbind("click");bungieNetPlatform.communitySearch.getUsersPaged($(this).data("value"),$(this).data("page")-1,$(this).data("container"))}).show(),$(".footer_search_section").append($('<div class="clear"/>'))):$(".prev_page").hide(),o=0;o<u.results.length;o++){var f=u.results[o],s=f.displayName,e=f.membershipId,h=f.profilePicturePath,l=f.userTitle,c=f.uniqueName,a=f.firstAccess;$userItem=$('<li class="cf user" data-membershipId="'+e+'"><a href="'+PageUrls.profilePage+"/"+e+'" class="avatar flyoutExempt1"><img alt="" data-membershipId="'+e+'" src="'+Utility.ContentVersioned(h)+'" data-avatarPath="" /><\/a><div class="content"><a href="'+PageUrls.profilePage+"/"+e+'" data-displayName="" data-membershipId="'+e+'" class="flyoutExempt2">'+s+' <span data-uniqueName="" data-membershipId="'+e+'">('+c+")<\/span><\/a><\/div><\/li>");r.find(".container_users").append($userItem)}t==1&&bungieNetPlatform.communitySearch.getDestinyUsers(n,i,!1)}else t==1?bungieNetPlatform.communitySearch.getDestinyUsers(n,i,!0):(r.find(".container_users").addClass("noResults"),$("#user_noresults_span").show())},function(n){r.find(".container_users").addClass("errorSection").append("<li class='noResults'>"+n.errorMessage+"<\/li>")}):(r.find(".container_users").addClass("noResults"),$("#user_noresults_span").show())},getDestinyUsers:function(n,t,i){bungieNetPlatform.destiny2Service.SearchDestinyPlayer("All",n,function(n){var o=t.find(".searchUsers, .users"),f;if(o.find(".container_users.noResults").removeClass("noResults"),n.length>0)for(f=0;f<n.length;f++){var e=n[f],s=e.displayName,r=e.membershipId,u=e.membershipType,h=e.iconPath;$userItem=$('<li class="cf user" data-membershipId="'+r+'" data-membershipType="'+u+'"><a href="'+PageUrls.profilePage+"/"+u+"/"+r+'" class="avatar flyoutExempt3"><img alt="" data-membershipId="'+r+'" data-membershipType="'+u+'" src="'+Utility.ContentVersioned(h)+'" data-avatarPath="" /><\/a><div class="content"><a class="flyoutExempt4" href="'+PageUrls.profilePage+"/"+u+"/"+r+'" data-displayName="" data-membershipId="'+r+'" data-membershipType="'+u+'" class="">'+s+' <span data-uniqueName="" data-membershipId="'+r+'" data-membershipType="'+u+'"><\/span><\/a><\/div><\/li>');o.find(".container_users").append($userItem)}else i&&(o.find(".container_users").addClass("noResults"),$("#user_noresults_span").show())},function(){var n=t.find(".searchUsers, .users");n.find(".container_users").addClass("noResults");$("#user_noresults_span").show()})},getGroups:function(n,t,i,r,u){var e=i.find(".searchGroups, #searchGroups"),f,h,o,s,c;if(e.find(".container_groups.noResults").removeClass("noResults"),e.find("li").remove(),f={itemsPerPage:t,currentPage:1},h="",u){for(o=n.split(" "),s=0;s<o.length;s++)o[s]="#"+o[s];h=o.join(" ");f.tagText=h;c=h}else f.contents={searchValue:n,searchType:Globals.TextParameterSearchType.StartsWith};bungieNetPlatform.groupService.GroupSearch(f,!0,function(n){var s,o,g,l,a,h,b;if(n.totalResults>0){for($("#groups_noresults_span").hide(),u?i.find(".searchGroups h2").addClass("hasMore").bind("click.gotoGroups",function(n){n.preventDefault();window.location=PageUrls.clansSearch+"/"+c.replace(/#/gi,"%23")}):i.find(".searchGroups h2").addClass("hasMore").bind("click.gotoGroups",function(n){n.preventDefault();window.location=PageUrls.clansSearch+"/"+f.contents.searchValue}),n.hasMore?u?$("#groups_page2_link").attr("href",PageUrls.clansSearch+"/"+c.replace(/#/gi,"%23")).show():$("#groups_page2_link").attr("href",PageUrls.clansSearch+"/"+f.contents.searchValue).show():$("#groups_page2_link").attr("href","").hide(),s={},o=0;o<n.founders.length;o++)s[n.founders[o].membershipId]=n.founders[o];for(n.totalResults<t&&(t=n.totalResults),o=0;o<n.results.length;o++){var r=n.results[o],v=r.detail.groupId,nt=r.detail.creationDate,k=r.detail.name,d=r.detail.about,y=r.founderMembershipId,w,p=r.detail.memberCount;for(w=p==1||p==0&&Localizer.CurrentCultureName.indexOf("fr")>-1?p+" "+Localizer.Search.member:p+" "+Localizer.Search.members,l=r.followerCount,g=l==1||l==0&&Localizer.CurrentCultureName.indexOf("fr")>-1?l+" "+Localizer.Search.follower:l+" "+Localizer.Search.followers,a="",h=0;h<r.detail.tags.length;h++)h>0&&(a+=", "),a+='<a href="'+PageUrls.clansSearch+"/"+Utility.GetValidTags(r.detail.tags[h],!0)+'">'+r.detail.tags[h]+"<\/a>";b=$('<li class="cf" data-groupId="'+v+'"><a href="'+PageUrls.clanDetail+"/"+v+'" class="avatar"><img alt="" src="'+Utility.ContentVersioned(r.detail.avatarPath)+'" /><\/a><div class="content"><p class="members"><a href="'+PageUrls.clanDetail+"/"+v+'" class="">'+w+'<\/a><\/p><a href="'+PageUrls.clanDetail+"/"+v+'">'+k+'<\/a><p class="about">'+d+'<\/p><div class="links">'+(typeof s[y]!="undefined"?"<p>"+Localizer.Groups.foundedon+' <time datetime="'+r.detail.creationDate+'">'+Utility.getLocalTimeString(r.detail.creationDate,!1,!0)+"<\/time> "+Localizer.Groups.by+' <a href="'+PageUrls.profilePage+"/"+s[y].membershipId+'" data-membershipId="'+s[y].membershipId+'">'+s[y].displayName+"<\/a><\/p>":"")+(a!==""?'<p class="tags">'+a+"<\/p>":"")+"<\/div><\/div><\/li>");e.find(".container_groups").append(b)}}else e.find(".container_groups").addClass("noResults"),$("#groups_noresults_span").show()},function(n){e.find(".container_groups").addClass("errorSection").append("<li class=''>"+n.errorMessage+"<\/li>")})},resetPreview:function(){var n=$("#searchPreview").find(".searchPanel");n.closest(".header_page").css("z-index","");n.find("li").remove()},closePreview:function(){$("#SearchWidget.open").removeClass("open");this.resetPreview();$("#searchPreview").hide()},resetTagsPreview:function(){$("#searchTagsPreview").closest(".header_page").css("z-index","");$("#searchTagsPreview").find("li").remove()},closeTagsPreview:function(){this.resetTagsPreview();$("#SearchWidget.open").removeClass("open");$("#searchTagsPreview").hide()},keyStoppedHandler:function(n){var f=3,u;if(Localizer.CurrentCultureName=="ja"&&(f=1),$.trim(n.val()).length>=f){var i=$("#searchPreview"),r=$("#searchTagsPreview"),t=$.trim(n.val().replace(/<|>/g,""));if(n.val(t),u=3,t.indexOf("#")===0){if(this.doSearch(t,u,r,"all",!0),this.resetPreview(),this.closePreview(),this.resetAdvanced(),this.resetTagsPreview(),r.show(),r.closest(".header_page").css("z-index","2"),$("#SearchWidget .btn_viewMore").each(function(){var n=$(this);n.attr("href").indexOf("replace")!==-1?n.attr("href",n.attr("href").replace("replace",Utility.GetValidTags(t,!0))):n.attr("href",n.attr("href").replace(/([p|g|u]Id=).+/,"$1"+Utility.GetValidTags(t,!0)))}),!r.is(":visible")){this.resetPreview();this.resetAdvanced();this.resetTagsPreview();this.closePreview();$("#SearchWidget").addClass("open");r.show();r.closest(".header_page").css("z-index","2");$(document).on("click.search",function(n){$(n.target).is(".nav_top_search, .nav_top_search *")||(r.hide(),$("#SearchWidget.open").removeClass("open"))})}}else if(this.doSearch(t,u,i),this.closeTagsPreview(),this.resetTagsPreview(),$("#SearchWidget .btn_viewMore").each(function(){var n=$(this);n.attr("href").indexOf("replace")!==-1?n.attr("href",n.attr("href").replace("replace",t)):n.attr("href",n.attr("href").replace(/([p|g|u]Id=).+/,"$1"+t))}),!i.is(":visible")){this.resetPreview();this.resetAdvanced();this.resetTagsPreview();this.closeTagsPreview();$("#SearchWidget").addClass("open");i.position().top+i.outerHeight()>$(window).height()?this.redirectToSearchPage(t):(i.show(),i.closest(".header_page").css("z-index","2"));$(document).on("click.search",function(n){$(n.target).is(".nav_top_search, .nav_top_search *")||(i.hide(),$("#SearchWidget.open").removeClass("open"))})}}else this.resetPreview(),this.resetTagsPreview()},setKeyTimeout:function(n){var t=this;t.keyTimeout=setTimeout(function(){t.keyStoppedHandler(n);clearTimeout(t.keyTimeout);t.keyTimeout=!1},500)},redirectToSearchPage:function(n){var t="?all="+n;Utility.ValidateTags(n,!0)&&(t+="&isTag=true");window.location=PageUrls.searchPage+t}};$(document).ready(function(){var n=$("#searchAdvanced"),t=$("#searchPreview"),i=$("#searchTagsPreview");$(document).on("click.search",".btn_search",function(n){n.preventDefault();var i=$(this),t="";i.parent().hasClass("form_search")||typeof $("#text_search_page").val()!="undefined"&&$("#text_search_page").val()!==""&&(t=encodeURIComponent($("#text_search_page").val().replace(/<|>/g,"")),bungieNetPlatform.communitySearch.redirectToSearchPage(t))});t.on("click","li.search",function(n){var i=$(this),t;n.stopImmediatePropagation();n.preventDefault();t=i.closest(".searchPanel");t.hasClass("searchUsers")?window.location=PageUrls.profilePage+"/"+i.data("membershipid"):t.hasClass("searchTags")?window.location=PageUrls.defaultPostPage+"/"+i.data("topicid"):t.hasClass("searchGroups")&&(window.location=$(this).find("a").get(0).href);bungieNetPlatform.communitySearch.closePreview()});$("#text_search").on("focus.search",function(){$("#SearchWidget").find(".flyout_search:visible").length==0&&($("#text_search").val().indexOf("#")>-1?i.find("li").length&&i.show():t.find("li").length&&(t.show(),$("#SearchWidget").addClass("open")))});$(document).on("keyup.search","#text_search",function(r){var e,o,u,f;if($("#GlobalSearch").hasClass("active")){if(e=[16,17,18],!r.altKey&&!r.ctrlKey&&e.indexOf(r.which)===-1){if(r.which===13){$(".nav_top_search .btn_search").click();return}if(o=[37,38,39,40],o.indexOf(r.which)!=-1){bungieNetPlatform.communitySearch.caretPos=$("#text_search")[0].selectionEnd;return}if(bungieNetPlatform.communitySearch.caretPos=0,u=$(this),n.is(":visible"))return;if(f=3,Localizer.CurrentCultureName=="ja"&&(f=1),u.val().length<f){clearTimeout(bungieNetPlatform.communitySearch.keyTimeout);bungieNetPlatform.communitySearch.keyTimeout=!1;bungieNetPlatform.communitySearch.resetPreview();t.hide();bungieNetPlatform.communitySearch.resetTagsPreview();i.hide();$("#SearchWidget.open").removeClass("open");return}bungieNetPlatform.communitySearch.keyTimeout!==!1?(clearTimeout(bungieNetPlatform.communitySearch.keyTimeout),bungieNetPlatform.communitySearch.keyTimeout=!1,bungieNetPlatform.communitySearch.setKeyTimeout(u)):bungieNetPlatform.communitySearch.setKeyTimeout(u)}}else r.preventDefault(),$(this).val("")});$("#trigger_searchAdvanced").bind("click",function(t){t.preventDefault();bungieNetPlatform.communitySearch.closePreview();bungieNetPlatform.communitySearch.closeTagsPreview();$("#SearchWidget.open").removeClass("open");var i=$(this);n.hasClass("opened")?(n.removeClass("opened"),bungieNetPlatform.communitySearch.resetAdvanced()):(i.closest(".header_page").css("z-index","2"),n.addClass("opened"),n.find(".panel").first().addClass("opened"),$("#tags_tags").val($("#text_search").val()))});$("#select_searchWhat").bind("change",function(){var t=$(this),n=t.val();$(".panel_"+n).hasClass("opened")||($(".panel_"+n).addClass("opened").siblings(".panel.opened").removeClass("opened"),$(".panel_"+n).siblings(".panel").each(function(){bungieNetPlatform.communitySearch.resetAdvanced($(this))}))});$("#btn_searchAdvanced").bind("click",function(n){var r,t;if(n.preventDefault(),r=$("#select_searchWhat").val(),t="",r!=="users")if(r==="groups"){var i="",u=$("#groups_dateCreated").val(),f=$("#groups_tags").val(),e=$.trim($("#groups_groupName").val());i="?name="+e+"&tags="+Utility.prepareTagsStringForPlatform(f)+"&date="+u;t=PageUrls.groupIndexPage+i;window.location=t}else if(r==="tags"){var i="",u=$("#tags_dateCreated").val(),f=$.trim($("#tags_tags").val()),o=$("#tags_type").val(),s=$("#tags_sort").val();i="?d="+u+"&tg="+Utility.prepareTagsStringForPlatform(f)+"&ty="+o+"&s="+s;t=PageUrls.forumView+i;window.location=t}bungieNetPlatform.communitySearch.resetAdvanced()})});SignIn={};$(document).ready(function(){SignIn={decorateSignInAlert:function(n,t,i){n&&(typeof i!="undefined"&&i!==""&&$("#signInAlert").addClass(i),typeof t!="undefined"&&t!==""?n.before(t):n.before(Localizer.Userpages.validateaccountsignin))},showSignInAlert:function(n,t,i){var r,u;$("#signInAlert").is(":visible")||(r=new LightBox(null,$("#signInAlert")),i&&(r.afterClose=function(){window.location=window.location}),r.showLightbox(),u=$($("#container_signIn_script").html()),r.loadLightbox(u,!0),this.decorateSignInAlert(u,n,t))},notSignedIn:function(){return myID_cookie!=="0"?!1:(this.showSignInAlert(),!0)}}});$(document).off("userLogOut");$(document).on("userLogOut",function(){$("body").hasClass("nosignout")||SignIn.showSignInAlert(Localizer.Userpages.signbackin,"noalert",!0)});TagSuggestions=function(n,t){n.length<1||t.length<1||(this.$el=n,this.$suggestionPanel=t,this.tagSuggestTimeout=!1,this.addEventListeners())};TagSuggestions.prototype.setSearchTagsPreviewTimeout=function(){var n=this;this.tagSuggestTimeout=setTimeout(function(){n.searchForTags(n.$el);n.clearSearchTagsTimeout()},500)};TagSuggestions.prototype.clearSearchTagsTimeout=function(){clearTimeout(this.tagSuggestTimeout);this.tagSuggestTimeout=!1};TagSuggestions.prototype.resetSearchTagsPreview=function(){this.$suggestionPanel.find("li").remove()};TagSuggestions.prototype.closeTagsPreview=function(){this.resetSearchTagsPreview();this.$suggestionPanel.removeClass("opened")};TagSuggestions.prototype.addEventListeners=function(){var n=this;this.$el.on("keyup.tagSuggest",function(){var t=$(this);if(t.val().length<3){n.closeTagsPreview();return}n.tagSuggestTimeout!==!1?(n.clearSearchTagsTimeout(),n.setSearchTagsPreviewTimeout(t)):n.setSearchTagsPreviewTimeout(t)});this.$suggestionPanel.on("click","li",function(){var s=$(this),f=s.text(),t=n.$el.val(),r=[],u=[],e=0,o=0,i;if(t.indexOf(" ")>-1){for(r=t.split(" "),u=Utility.getIndicesOf(" ",t,!1),e=Utility.getCaret(n.$el.get(0)),i=0;i<u.length;i++)u[i]<e&&o++;r[o]=f;t=r.join(" ")}else t=f;n.$el.val(t);n.closeTagsPreview()});this.$el.on("blur.tagSuggest",function(){setTimeout(function(){n.$el.is(":focus")||n.closeTagsPreview()},500)})};TagSuggestions.prototype.searchForTags=function(n){var t=this,r;if(n.val().length>2&&Utility.ValidateTags(n.val())){var i=n.val(),f=[],u=[],e=0,o=0;if(i.trim().indexOf(" ")>-1){for(f=i.split(" "),u=Utility.getIndicesOf(" ",i,!1),e=Utility.getCaret(this.$el.get(0)),r=0;r<u.length;r++)u[r]<e&&o++;i=f[o]}bungieNetPlatform.forumService.GetForumTagSuggestions(i,function(n){var i,r;if(n.length>0)for(t.resetSearchTagsPreview(),i=0;i<n.length;i++)t.$suggestionPanel.is(":visible")||t.$suggestionPanel.addClass("opened"),r="<li>"+n[i].tagText+"<\/li>",t.$suggestionPanel.append(r);else t.resetSearchTagsPreview()},function(){t.resetSearchTagsPreview()})}else this.resetSearchTagsPreview()}